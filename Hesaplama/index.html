<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aƒ∞F Gider Formu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --card: #ffffff;
            --muted: #6b7280;
            --text: #000000;
            --primary: #009872;
            --primary-600: #007a5e;
            --accent: #009872;
            --danger: #dc2626;
            --warning: #d97706;
            --border: #e5e7eb;
            --input: #ffffff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            background: radial-gradient(1200px 600px at 20% 0%, rgba(0, 152, 114, .05), transparent 60%),
                radial-gradient(900px 500px at 80% 0%, rgba(0, 152, 114, .03), transparent 60%),
                var(--bg);
            color: var(--text);
            margin: 0;
            padding: 24px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
            border: 2px solid var(--primary);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 152, 114, .1), inset 0 1px 0 rgba(255, 255, 255, .9);
            backdrop-filter: blur(8px);
        }

        h2 {
            margin: 0 0 16px;
            text-align: center;
            font-weight: 700;
            letter-spacing: .3px;
            color: var(--primary);
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: var(--muted);
            margin-bottom: 24px;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: var(--muted);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--input);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 10px;
            outline: none;
            transition: border-color .15s, box-shadow .15s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 152, 114, .15);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 70px;
        }

        .items-container {
            margin: 8px 0 16px;
        }

        .item {
            border: 1px solid var(--border);
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 12px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .9), rgba(248, 250, 252, .7));
            border: 1px solid var(--primary);
        }

        .add-item-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .add-item-button:hover {
            background-color: var(--primary-600);
        }

        .remove-item-button {
            padding: 6px 10px;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            float: right;
        }

        .remove-item-button:hover {
            filter: brightness(.95);
        }

        .button-container {
            text-align: right;
        }

        button[type="submit"] {
            padding: 10px 16px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        button[type="submit"]:hover {
            filter: brightness(1.05);
        }

        #spinner {
            display: none;
            margin: 12px auto 0;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, .2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            color: #fca5a5;
            font-weight: 600;
            margin-top: 10px;
        }

        .route-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .calculate-km-btn {
            background-color: var(--accent);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 6px;
            font-weight: 600;
        }

        .calculate-km-btn:hover {
            filter: brightness(1.05);
        }

        .km-loading {
            display: none;
            color: var(--accent);
            font-size: 12px;
            margin-top: 6px;
        }

        .suggestions {
            position: absolute;
            left: 0;
            right: 0;
            z-index: 10;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 10px;
            display: none;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, .15);
        }

        .suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid rgba(226, 232, 240, .6);
        }

        .suggestion-item:last-child {
            border-bottom: 0;
        }

        .suggestion-item:hover {
            background: rgba(0, 152, 114, .08);
        }

        .amount-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 600px) {
            .amount-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- pdfMake k√ºt√ºphanesi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>

<body>
    <!-- ≈ûifre Giri≈üi Modal -->
    <div id="passwordModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div
            style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
            <h2 style="margin: 0 0 10px; text-align: center; color: #009872;">üîê Giri≈ü Gerekli</h2>
            <p style="text-align: center; color: #6b7280; margin-bottom: 20px; font-size: 14px;">Bu forma eri≈ümek i√ßin
                ≈üifre giriniz</p>
            <input type="password" id="passwordInput" placeholder="≈ûifre"
                style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; margin-bottom: 15px; outline: none;"
                onkeypress="if(event.key==='Enter') checkPassword()">
            <button onclick="checkPassword()"
                style="width: 100%; padding: 12px; background: #009872; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">Giri≈ü
                Yap</button>
            <div id="passwordError"
                style="color: #dc2626; text-align: center; margin-top: 10px; font-size: 14px; display: none;">‚ùå Hatalƒ±
                ≈üifre!</div>
        </div>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <h2>Aƒ∞F Gider Formu</h2>
        <div class="subtitle">Gider kalemlerinizi ekleyin, belgeleri y√ºkleyin ve g√∂nderin.</div>
        <form id="expenseForm" onsubmit="handleSubmit(event)">
            <div class="form-row">
                <div class="form-group">
                    <label for="name">ƒ∞sim</label>
                    <input type="text" id="name" name="name" placeholder="Adƒ±nƒ±zƒ± giriniz" required>
                </div>
                <div class="form-group">
                    <label for="surname">Soyisim</label>
                    <input type="text" id="surname" name="surname" placeholder="Soyadƒ±nƒ±zƒ± giriniz" required>
                </div>
            </div>
            <div class="items-container" id="itemsContainer"></div>
            <button type="button" class="add-item-button" onclick="addItem()">+ Kalem ekle</button>
            <div class="form-row">
                <div class="form-group">
                    <label for="iban">IBAN</label>
                    <input type="text" id="iban" name="iban" placeholder="TR.., AT.. (4‚Äôl√º bloklarla)" required>
                </div>
                <div class="form-group">
                    <label for="total">Toplam Tutar (‚Ç¨)</label>
                    <input type="number" id="total" name="total" readonly>
                </div>
            </div>
            <div class="button-container">
                <button type="submit">Gideri bildir</button>
            </div>
        </form>
        <div id="spinner"></div>
        <div id="errorMessage" class="error-message"></div>
    </div>

    <script>
        // G√ºvenli ≈üifre kontrol√º - PHP backend ile

        // Sayfa y√ºklendiƒüinde session kontrol et
        window.addEventListener('DOMContentLoaded', async function () {
            await checkSession();
        });

        // Session kontrol√º (PHP backend)
        async function checkSession() {
            try {
                const response = await fetch('verify_session.php');
                const data = await response.json();

                if (data.authenticated) {
                    // Zaten giri≈ü yapƒ±lmƒ±≈ü
                    showForm();
                } else {
                    // ≈ûifre modal'ƒ±nƒ± g√∂ster
                    showPasswordModal();
                }
            } catch (error) {
                console.error('Session kontrol hatasƒ±:', error);
                // Hata durumunda ≈üifre iste
                showPasswordModal();
            }
        }

        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            // Input'a focus
            setTimeout(() => {
                document.getElementById('passwordInput').focus();
            }, 100);
        }

        function showForm() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        // ≈ûifre kontrol√º (PHP backend ile)
        async function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            const button = document.querySelector('#passwordModal button');
            const password = input.value;

            if (!password) {
                error.textContent = '‚ö†Ô∏è L√ºtfen ≈üifre giriniz';
                error.style.display = 'block';
                return;
            }

            // Loading durumu
            button.disabled = true;
            button.textContent = 'Kontrol ediliyor...';
            error.style.display = 'none';

            try {
                // PHP backend'e ≈üifre g√∂nder
                const response = await fetch('check_password.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });

                const data = await response.json();

                if (data.success) {
                    // ≈ûifre doƒüru
                    error.style.display = 'none';
                    input.value = '';
                    showForm();
                } else {
                    // ≈ûifre yanlƒ±≈ü
                    error.textContent = '‚ùå Hatalƒ± ≈üifre!';
                    error.style.display = 'block';
                    input.value = '';
                    input.focus();
                    // Input'u kƒ±rmƒ±zƒ± yap
                    input.style.borderColor = '#dc2626';
                    setTimeout(() => {
                        input.style.borderColor = '#e5e7eb';
                    }, 2000);
                }
            } catch (error) {
                console.error('≈ûifre kontrol hatasƒ±:', error);
                error.textContent = '‚ùå Baƒülantƒ± hatasƒ±!';
                error.style.display = 'block';
            } finally {
                // Loading durumunu kaldƒ±r
                button.disabled = false;
                button.textContent = 'Giri≈ü Yap';
            }
        }

        // pdf.js worker ayarƒ±
        if (window['pdfjsLib']) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
        // T√ºrk√ße karakterler i√ßin font y√ºkleyici
        async function useTurkishFont(doc) {
            try {
                // jsPDF'de T√ºrk√ße karakterler i√ßin en iyi √ß√∂z√ºm
                // Helvetica font'u T√ºrk√ße karakterleri destekler
                doc.setFont('helvetica', 'normal');

                // Alternatif olarak Times font'u da deneyebiliriz
                // doc.setFont('times', 'normal');

                console.log('T√ºrk√ße font ayarlandƒ±: helvetica');
                return true;
            } catch (e) {
                console.log('Font hatasƒ±:', e);
                // Son √ßare olarak default font
                doc.setFont('helvetica', 'normal');
                return false;
            }
        }
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) { binary += String.fromCharCode(bytes[i]); }
            return btoa(binary);
        }
        function formatCurrency(value) {
            const n = typeof value === 'number' ? value : parseFloat(String(value).replace(/[^0-9.]/g, '')) || 0;
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'EUR' }).format(n);
        }
        function getAndIncrementGiderNo() {
            const key = 'aif_gider_no';
            let val = parseInt(localStorage.getItem(key) || '92', 10); // √∂rnek ba≈ülangƒ±√ß
            val = isNaN(val) ? 92 : val;
            val += 1;
            localStorage.setItem(key, String(val));
            return val;
        }
        let uploadedImages = [];
        let itemCounter = 0;
        if (typeof ORS_API_KEY === 'undefined') {
            var ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjdiYWRhNGRlODEwNjQ1ZjY4NmI0MmMzZDgwOTExODJlIiwiaCI6Im11cm11cjY0In0=';
        }
        const AUTOCOMPLETE_DEBOUNCE_MS = 250;
        const DEBUG = false; // Konsol √ßƒ±ktƒ±sƒ±nƒ± azalt
        const geocodeCache = {};
        const routeCache = {};

        // Global hata filtreleme - daha kapsamlƒ± (WordPress/Elementor i√ßin)
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        console.error = function (...args) {
            const message = args.join(' ');
            // WordPress tema scriptlerinin hatalarƒ±nƒ± filtrele
            if (message.includes('dpt.js') ||
                message.includes('updateTimeDifferenceInterval') ||
                message.includes('Cannot read properties of null') ||
                message.includes('reading \'value\'')) {
                return; // Bu hatalarƒ± g√∂sterme
            }
            originalConsoleError.apply(console, args);
        };

        console.warn = function (...args) {
            const message = args.join(' ');
            if (message.includes('dpt.js') ||
                message.includes('updateTimeDifferenceInterval')) {
                return; // Bu uyarƒ±larƒ± g√∂sterme
            }
            originalConsoleWarn.apply(console, args);
        };

        // Uncaught Exception filtreleme
        window.addEventListener('unhandledrejection', (e) => {
            if (e.reason && e.reason.toString().includes('dpt.js')) {
                e.preventDefault();
                return;
            }
        });

        function debounce(fn, delay) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), delay);
            };
        }

        // Basit log
        function dlog(...args) { if (DEBUG && window && window.console) { console.log('[gider-formu]', ...args); } }

        // Hata yakalama ve temizleme - daha agresif filtreleme
        window.addEventListener('error', (e) => {
            // dpt.js ve diƒüer harici script hatalarƒ±nƒ± filtrele
            if (e.filename && (e.filename.includes('dpt.js') || e.filename.includes('islamfederasyonu.at'))) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            // Sadece bizim script hatalarƒ±nƒ± g√∂ster
            if (e.filename && !e.filename.includes(window.location.hostname)) {
                e.preventDefault();
                return false;
            }
            // Null property hatalarƒ±nƒ± filtrele
            if (e.message && e.message.includes('Cannot read properties of null')) {
                e.preventDefault();
                return false;
            }
            const msg = document.getElementById('errorMessage');
            if (msg) { msg.textContent = e.error && e.error.message ? e.error.message : (e.message || 'Bilinmeyen hata'); }
            dlog('GlobalError:', e.error || e.message);
        });

        async function fetchAddressSuggestions(query) {
            if (!query || query.length < 2) return [];
            const url = `https://api.openrouteservice.org/geocode/autocomplete?api_key=${encodeURIComponent(ORS_API_KEY)}&text=${encodeURIComponent(query)}&size=5&boundary.country=AT,DE,CH&lang=tr`;
            const res = await fetch(url);
            const data = await res.json();
            if (!data.features) return [];
            return data.features.map(f => ({ label: f.properties.label || '', lon: f.geometry.coordinates[0], lat: f.geometry.coordinates[1] }));
        }

        function attachAutocomplete(inputEl, suggestionsEl) {
            const render = (items) => {
                suggestionsEl.innerHTML = '';
                if (!items.length) { suggestionsEl.style.display = 'none'; return; }
                suggestionsEl.style.display = 'block';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = item.label;
                    div.onclick = () => {
                        inputEl.value = item.label;
                        suggestionsEl.style.display = 'none';
                    };
                    suggestionsEl.appendChild(div);
                });
            };
            const debounced = debounce(async () => {
                const q = inputEl.value.trim();
                const items = await fetchAddressSuggestions(q).catch(() => []);
                render(items);
            }, AUTOCOMPLETE_DEBOUNCE_MS);
            inputEl.addEventListener('input', debounced);
            inputEl.addEventListener('blur', () => setTimeout(() => suggestionsEl.style.display = 'none', 150));
            inputEl.addEventListener('focus', () => { if (inputEl.value.trim().length >= 2) debounced(); });
        }

        // IBAN input: 4'l√º bloklar halinde g√∂rsel format
        document.addEventListener('DOMContentLoaded', () => {
            const ibanEl = document.getElementById('iban');
            if (ibanEl) {
                // Ba≈üta zorunlu 'AT' ve sadece rakam kabul et; toplam 20 karakter (AT + 18 rakam)
                const formatIbanAT = () => {
                    const raw = (ibanEl.value || '').replace(/\s+/g, '').toUpperCase();
                    // Sayƒ±larƒ± √ßek, harfleri (AT dƒ±≈üƒ±nda) yok say
                    const digits = raw.replace(/^AT/, '').replace(/[^0-9]/g, '').slice(0, 18);
                    const compact = 'AT' + digits;
                    const groups = compact.match(/.{1,4}/g);
                    ibanEl.value = groups ? groups.join(' ') : compact;
                };
                ibanEl.addEventListener('input', formatIbanAT);
                ibanEl.addEventListener('focus', () => { if (!ibanEl.value.trim()) { ibanEl.value = 'AT '; } else { formatIbanAT(); } });
                ibanEl.addEventListener('blur', () => {
                    const valid = isValidAustrianIban(ibanEl.value);
                    const err = document.getElementById('errorMessage');
                    if (!valid) {
                        err.textContent = 'IBAN ge√ßersiz. Avusturya IBAN\'ƒ± AT ile ba≈ülar ve 20 karakterdir.';
                    } else {
                        err.textContent = '';
                    }
                });
                // ƒ∞lk y√ºklemede de AT ile ba≈ülat
                if (!ibanEl.value.trim()) { ibanEl.value = 'AT '; }
            }
        });

        function isValidAustrianIban(input) {
            const cleaned = (input || '').replace(/\s+/g, '').toUpperCase();
            return /^AT[0-9]{18}$/.test(cleaned);
        }

        function addItem() {
            const container = document.getElementById('itemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'item';
            const itemId = itemCounter++;

            newItem.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Tarih</label>
                        <input type="date" name="position-datum[]" required>
                    </div>
                    <div class="form-group">
                        <label>B√∂lge Y√ºr√ºtme Kurulu</label>
                        <select name="region[]" required>
                            <option value="AT">AT</option>
                            <option value="KT">KT</option>
                            <option value="GT">GT</option>
                            <option value="KGT">KGT</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Birim</label>
                        <select name="birim[]" required>
                            <option value="baskan">Ba≈ükan</option>
                            <option value="byk">BYK √úyesi</option>
                            <option value="egitim">Eƒüitim</option>
                            <option value="fuar">Fuar</option>
                            <option value="gob">Spor/Gezi (GOB)</option>
                            <option value="hacumre">Hac/Umre</option>
                            <option value="idair">ƒ∞dari ƒ∞≈üler</option>
                            <option value="irsad">ƒ∞r≈üad</option>
                            <option value="kurumsal">Kurumsal ƒ∞leti≈üim</option>
                            <option value="muhasebe">Muhasebe</option>
                            <option value="ortaogretim">Orta √ñƒüretim</option>
                            <option value="raggal">Raggal</option>
                            <option value="sosyal">Sosyal Hizmetler</option>
                            <option value="tanitma">Tanƒ±tma</option>
                            <option value="teftis">Tefti≈ü</option>
                            <option value="teskilatlanma">Te≈ükilatlanma</option>
                            <option value="universiteler">√úniversiteler</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>√ñdeme ≈ûekli</label>
                        <select name="odeme-sekli[]" required onchange="handleOdemeSekliChange(this)">
                            <option value="">L√ºtfen se√ßin</option>
                            <option value="faturalƒ±">Faturalƒ±</option>
                            <option value="faturasƒ±z">Faturasƒ±z</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kategori</label>
                        <select name="gider-turu[]" required onchange="handleGiderTuruChange(this)">
                            <option value="">L√ºtfen se√ßin</option>
                            <option value="genel">Genel</option>
                            <option value="ikram">ƒ∞kram</option>
                            <option value="ulasim">Ula≈üƒ±m - Kilometre Hesaplama</option>
                            <option value="yakit">Ula≈üƒ±m - Faturali/Kasabon</option>
                            <option value="malzeme">Malzeme</option>
                            <option value="konaklama">Konaklama</option>
                            <option value="buro">B√ºro</option>
                            <option value="diger">Diƒüer</option>
                        </select>
                    </div>
                </div>
                <div class="form-group yakit-fields" style="display:none;">
                    <label>Rota (Otomatik Mesafe)</label>
                    <div class="route-inputs">
                        <div style="position:relative;">
                            <input type="text" class="route-start" placeholder="Amberggsse 10, 6800 Feldkirch" data-item="${itemId}">
                            <div class="suggestions"></div>
                        </div>
                        <div style="position:relative;">
                            <input type="text" class="route-end" placeholder="Sterzingerstra√üe 6, 6020 Innsbruck" data-item="${itemId}">
                            <div class="suggestions"></div>
                        </div>
                    </div>
                    <button type="button" class="calculate-km-btn" onclick="calculateDistance(${itemId})">üó∫Ô∏è Mesafeyi Hesapla</button>
                    <div class="km-loading" id="loading-${itemId}">Hesaplanƒ±yor...</div>
                    <input type="text" name="route" class="route-full" placeholder="Tam rota a√ßƒ±klamasƒ±" style="margin-top:10px;">
                </div>
                <div class="form-group yakit-fields" style="display:none;">
                    <label>Toplam Kilometre</label>
                    <input type="number" name="kilometer" class="kilometer-field" placeholder="Toplam km" step="0.01" onchange="calculateYakitAmount(this)" data-item="${itemId}">
                </div>
                <div class="amount-row">
                    <!-- KDV Alanlarƒ± - Sadece Faturali se√ßildiƒüinde g√∂sterilir -->
                    <div class="form-group kdv-fields" style="display:none;">
                        <label>Gider Miktarƒ± (‚Ç¨) Net</label>
                        <input type="text" name="gider-netto[]" onchange="calculateBruttoFromNetto(this)" oninput="formatToDecimal(this)">
                    </div>
                    <div class="form-group kdv-fields" style="display:none;">
                        <label>KDV</label>
                        <input type="text" name="gider-kdv[]" onchange="calculateBruttoFromNetto(this)" oninput="formatToDecimal(this)">
                    </div>
                    <!-- Normal Gider Miktarƒ± - Her zaman Br√ºt olarak kullanƒ±lƒ±r -->
                    <div class="form-group brutto-field">
                        <label>Gider Miktarƒ± (‚Ç¨) Br√ºt</label>
                        <input type="text" name="gider-miktari[]" required onchange="calculateTotal()" oninput="formatToDecimal(this)">
                    </div>
                </div>
                <div class="form-group">
                    <label>A√ßƒ±klama (Opsiyonel)</label>
                    <textarea name="beschreibung[]" rows="2" placeholder="Kƒ±sa a√ßƒ±klama"></textarea>
                </div>
                <div class="form-group">
                    <label>Belgeler (G√∂rsel/PDF)</label>
                    <input type="file" class="item-documents" accept=".jpg,.jpeg,.png,.webp,.heic,image/webp,.pdf,application/pdf" multiple>
                </div>
                <button type="button" class="remove-item-button" onclick="removeItem(this)">Kaldƒ±r</button>
            `;

            container.appendChild(newItem);
            // Autocomplete baƒülama
            const [startWrapper, endWrapper] = newItem.querySelectorAll('.route-inputs > div');
            const startInput = startWrapper.querySelector('.route-start');
            const endInput = endWrapper.querySelector('.route-end');
            const startSug = startWrapper.querySelector('.suggestions');
            const endSug = endWrapper.querySelector('.suggestions');
            attachAutocomplete(startInput, startSug);
            attachAutocomplete(endInput, endSug);
            calculateTotal();
        }

        // üöÄ OpenRouteService ile otomatik mesafe hesaplama
        async function calculateDistance(itemId) {
            const item = document.querySelector(`input[data-item="${itemId}"]`).closest('.item');
            const startInput = item.querySelector('.route-start');
            const endInput = item.querySelector('.route-end');
            const kmField = item.querySelector('.kilometer-field');
            const routeField = item.querySelector('.route-full');
            const loading = document.getElementById(`loading-${itemId}`);

            const start = startInput.value.trim();
            const end = endInput.value.trim();

            if (!start || !end) {
                alert('L√ºtfen ba≈ülangƒ±√ß ve biti≈ü adreslerini girin.');
                return;
            }

            loading.style.display = 'block';

            try {
                // Geocoding (ORS) -> Rota (OSRM) Hƒ±zlƒ± Yol
                const startCoords = await geocodeCity(start);
                const endCoords = await geocodeCity(end);
                if (!startCoords || !endCoords) { throw new Error('Adres bulunamadƒ±. L√ºtfen ge√ßerli bir adres girin.'); }
                const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${startCoords.lon},${startCoords.lat};${endCoords.lon},${endCoords.lat}?overview=false`;
                const osrmRes = await fetch(osrmUrl);
                const osrmData = await osrmRes.json();
                if (osrmData.code !== 'Ok') { throw new Error('OSRM rota bulamadƒ±'); }
                const oneWayKm = osrmData.routes[0].distance / 1000;
                const roundTripKm = (oneWayKm * 2).toFixed(2);
                kmField.value = roundTripKm;
                routeField.value = `${start} ‚Üí ${end}`;
                calculateYakitAmount(kmField);
            } catch (error) {
                alert('Rota hesaplanamadƒ±: ' + (error.message || ''));
            } finally {
                loading.style.display = 'none';
            }
        }

        // Geocoding: Adresi koordinata √ßevir (OpenRouteService)
        async function geocodeCity(cityName) {
            const url = `https://api.openrouteservice.org/geocode/search?api_key=${encodeURIComponent(ORS_API_KEY)}&text=${encodeURIComponent(cityName)}&size=1&boundary.country=AT,DE,CH&lang=tr`;
            const response = await fetch(url);
            const data = await response.json();
            if (!data.features || data.features.length === 0) return null;
            const coords = data.features[0].geometry.coordinates; // [lon, lat]
            return { lat: parseFloat(coords[1]), lon: parseFloat(coords[0]) };
        }

        function formatToDecimal(input) {
            input.value = input.value.replace(',', '.');
            input.value = input.value.replace(/[^0-9.]/g, '');
            if ((input.value.match(/\./g) || []).length > 1) {
                input.value = input.value.substring(0, input.value.lastIndexOf('.'));
            }
        }

        function removeItem(button) {
            const item = button.closest('.item');
            item.remove();
            calculateTotal();
        }

        function calculateYakitAmount(input) {
            const kilometer = parseFloat(input.value) || 0;
            const giderMiktari = kilometer * 0.25;
            const giderField = input.closest('.item').querySelector('input[name="gider-miktari[]"]');
            giderField.value = giderMiktari.toFixed(2);
            calculateTotal();
        }

        function calculateTotal() {
            const amounts = document.querySelectorAll('input[name="gider-miktari[]"]');
            let total = 0;
            amounts.forEach(amount => { total += parseFloat(amount.value) || 0; });
            document.getElementById('total').value = total.toFixed(2);
        }

        function handleOdemeSekliChange(selectElement) {
            const item = selectElement.closest('.item');
            const kdvFields = item.querySelectorAll('.kdv-fields');
            const bruttoField = item.querySelector('input[name="gider-miktari[]"]');

            if (selectElement.value === 'faturalƒ±') {
                kdvFields.forEach(field => field.style.display = 'block');
                bruttoField.readOnly = true;
            } else {
                kdvFields.forEach(field => field.style.display = 'none');
                bruttoField.readOnly = false;
            }
        }

        function calculateBruttoFromNetto(input) {
            const item = input.closest('.item');
            const netto = parseFloat(item.querySelector('input[name="gider-netto[]"]').value) || 0;
            const kdv = parseFloat(item.querySelector('input[name="gider-kdv[]"]').value) || 0;
            const brutto = (netto + kdv).toFixed(2);
            item.querySelector('input[name="gider-miktari[]"]').value = brutto;
            calculateTotal();
        }

        function handleGiderTuruChange(selectElement) {
            const item = selectElement.closest('.item');
            const yakitFields = item.querySelectorAll('.yakit-fields');
            const giderField = item.querySelector('input[name="gider-miktari[]"]');
            const descArea = item.querySelector('textarea[name="beschreibung[]"]');
            yakitFields.forEach(field => field.style.display = 'none');
            giderField.readOnly = false;
            if (selectElement.value === 'ulasim') {
                yakitFields.forEach(field => field.style.display = 'block');
                giderField.readOnly = true;
                giderField.value = "";
                // A√ßƒ±klama alanƒ± her zaman g√∂r√ºn√ºr ve opsiyonel
                if (descArea) { descArea.required = false; }
            } else {
                giderField.value = "";
                // A√ßƒ±klama alanƒ± her zaman g√∂r√ºn√ºr ve opsiyonel
                if (descArea) { descArea.required = false; }
            }
        }

        // Global resim y√ºkleme kaldƒ±rƒ±ldƒ±; her kalem i√ßin ayrƒ± dosya alanƒ± zaten mevcut

        async function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function imageToJpegDataURL(dataUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width; canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    try {
                        const jpeg = canvas.toDataURL('image/jpeg', 0.9);
                        resolve(jpeg);
                    } catch (e) {
                        resolve(dataUrl); // fallback: orjinal
                    }
                };
                img.onerror = () => resolve(dataUrl);
                img.src = dataUrl;
            });
        }

        async function pdfFileToFirstPageImageDataURL(file, scale = 1.5) {
            try {
                if (!window['pdfjsLib']) return null;
                const buf = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({ canvasContext: ctx, viewport }).promise;
                const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                return dataUrl;
            } catch (_) {
                return null;
            }
        }

        async function collectItemImages(itemEl) {
            const input = itemEl ? itemEl.querySelector('.item-documents') : null;
            if (!input) { dlog('Dosya input yok'); return []; }
            if (!input.files) { dlog('input.files yok (null)'); return []; }
            if (input.files.length === 0) { dlog('Dosya se√ßilmemi≈ü'); return []; }
            const out = [];
            for (const file of Array.from(input.files)) {
                try {
                    if (file.type && file.type.startsWith('image/')) {
                        const dataUrl = await fileToDataURL(file);
                        const jpegDataUrl = await imageToJpegDataURL(dataUrl);
                        out.push(jpegDataUrl);
                    } else if (file.type === 'application/pdf') {
                        const img = await pdfFileToFirstPageImageDataURL(file);
                        if (img) out.push(img);
                    }
                } catch (_) { }
            }
            return out;
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const spinner = document.getElementById("spinner");
            const errorMessage = document.getElementById("errorMessage");
            errorMessage.textContent = "";
            // IBAN doƒürulamasƒ±: Avusturya IBAN (AT + 18 rakam = 20 karakter)
            const ibanVal = document.getElementById('iban').value;
            if (!isValidAustrianIban(ibanVal)) {
                errorMessage.textContent = 'IBAN ge√ßersiz. Avusturya IBAN\'ƒ± AT ile ba≈ülar ve 20 karakterdir.';
                return;
            }
            spinner.style.display = "block";
            try {
                const giderNo = await generatePDF();
                // Ba≈üarƒ±lƒ±! Te≈üekk√ºr sayfasƒ±na y√∂nlendir
                setTimeout(() => {
                    spinner.style.display = "none";
                    window.location.href = `success.html?gider_no=${giderNo}`;
                }, 700);
            } catch (error) {
                errorMessage.textContent = error.message;
                spinner.style.display = "none";
            }
        }

        async function addImagesToPDF(doc, images, yPos, maxWidth, maxHeight, margin) {
            for (const imgData of images) {
                const img = new Image();
                img.src = imgData;
                await new Promise(resolve => img.onload = resolve);
                let imgWidth = img.width; let imgHeight = img.height;
                // A≈üƒ±rƒ± b√ºy√ºk g√∂rseli k√º√ß√ºlt
                if (imgWidth > maxWidth) { const s = maxWidth / imgWidth; imgWidth *= s; imgHeight *= s; }
                if (imgHeight > 500) { const s2 = 500 / imgHeight; imgWidth *= s2; imgHeight *= s2; }
                if (yPos + imgHeight > maxHeight) { doc.addPage(); yPos = margin; }
                doc.addImage(imgData, 'JPEG', margin, yPos, imgWidth, imgHeight);
                yPos += imgHeight + 10;
            }
            return yPos;
        }

        // ƒ∞ki g√∂rsel tek sayfaya b√ºy√ºk sƒ±ƒüacak ≈üekilde yerle≈ütir
        async function addImagesTwoPerPage(doc, images, yPos, pageWidth, pageHeight, margin, labelPrefix = '', startIndex = 1) {
            const gap = 10;
            const contentW = pageWidth - 2 * margin;
            const contentH = pageHeight - 2 * margin;
            const maxHPerImage = Math.floor((contentH - gap) / 2); // iki g√∂rsel/ sayfa (√ºst + alt)
            let runningIndex = startIndex;
            let indexOnPage = 0;
            for (const imgData of images) {
                if (indexOnPage === 2 || yPos + 10 > pageHeight - margin) { doc.addPage(); yPos = margin; indexOnPage = 0; }
                const img = new Image();
                img.src = imgData;
                await new Promise(resolve => img.onload = resolve);
                let w = img.width; let h = img.height;
                let s = Math.min(contentW / w, maxHPerImage / h, 1);
                w = Math.max(1, Math.floor(w * s));
                h = Math.max(1, Math.floor(h * s));
                const x = margin + Math.floor((contentW - w) / 2); // ortala
                if (yPos + h > pageHeight - margin) { doc.addPage(); yPos = margin; indexOnPage = 0; }
                doc.addImage(imgData, 'JPEG', x, yPos, w, h);
                if (labelPrefix) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(60);
                    const label = `${labelPrefix}.${runningIndex}`;
                    doc.text(label, x + w, yPos + h + 12, { align: 'right' });
                    doc.setTextColor(20);
                }
                yPos += h + gap;
                runningIndex++;
                indexOnPage++;
            }
            return { yPos, nextIndex: runningIndex };
        }

        async function generatePDF() {
            try {
                // pdfmake kontrol√º
                if (!window.pdfMake) {
                    throw new Error('pdfMake k√ºt√ºphanesi y√ºklenemedi. Sayfayƒ± yenileyin.');
                }

                // DOM elementlerini g√ºvenli ≈üekilde al
                const nameEl = document.getElementById('name');
                const surnameEl = document.getElementById('surname');
                const ibanEl = document.getElementById('iban');
                const totalEl = document.getElementById('total');

                if (!nameEl || !surnameEl || !ibanEl || !totalEl) {
                    throw new Error('Form alanlarƒ± bulunamadƒ±');
                }

                const name = nameEl.value || '';
                const surname = surnameEl.value || '';
                const ibanRaw = ibanEl.value || '';
                const iban = ibanRaw.replace(/\s+/g, '');
                const total = totalEl.value || '0';

                // IBAN formatƒ±
                function formatIBAN(iban) {
                    if (!iban) return '';
                    return iban.replace(/(.{4})/g, '$1 ').trim();
                }

                // Tarih formatƒ±
                function formatDate(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('tr-TR');
                }

                const positions = document.querySelectorAll('.item');
                const giderNo = getAndIncrementGiderNo();
                const itemsForBackend = [];
                const tableBody = [];

                // Ekleri topla
                const attachmentImages = [];
                for (const position of Array.from(positions)) {
                    const images = await collectItemImages(position);
                    if (images.length > 0) {
                        images.forEach((imgData, idx) => {
                            attachmentImages.push({
                                url: imgData,
                                name: `Fatura ${Array.from(positions).indexOf(position) + 1}-${idx + 1}`,
                                itemIndex: Array.from(positions).indexOf(position)
                            });
                        });
                    }
                }

                // Items'ƒ± topla
                for (const position of Array.from(positions)) {
                    const datum = position.querySelector('input[name="position-datum[]"]').value || "-";
                    const regionSel = position.querySelector('select[name="region[]"]');
                    const region = regionSel ? regionSel.value : "-";
                    const birimSel = position.querySelector('select[name="birim[]"]');
                    const birim = birimSel ? birimSel.value : "-";
                    const birimLabel = birimSel && birimSel.selectedIndex >= 0 ? birimSel.options[birimSel.selectedIndex].text : birim;
                    const turSel = position.querySelector('select[name="gider-turu[]"]');
                    const giderTuru = turSel ? turSel.value : "-";
                    const giderTuruLabel = turSel && turSel.selectedIndex >= 0 ? turSel.options[turSel.selectedIndex].text : giderTuru;
                    const odemeSekliSel = position.querySelector('select[name="odeme-sekli[]"]');
                    const odemeSekli = odemeSekliSel ? odemeSekliSel.value : "";
                    const netto = position.querySelector('input[name="gider-netto[]"]').value || "0";
                    const kdv = position.querySelector('input[name="gider-kdv[]"]').value || "0";
                    const giderMiktari = position.querySelector('input[name="gider-miktari[]"]').value || "0";
                    const beschreibung = position.querySelector('textarea[name="beschreibung[]"]').value || "-";

                    const itemData = {
                        tarih: datum,
                        region,
                        birim,
                        birim_label: birimLabel,
                        gider_turu: giderTuru,
                        gider_turu_label: giderTuruLabel,
                        odeme_sekli: odemeSekli,
                        netto: parseFloat(netto) || 0,
                        kdv: parseFloat(kdv) || 0,
                        tutar: parseFloat(giderMiktari) || 0,
                        aciklama: beschreibung
                    };

                    if (giderTuru === 'ulasim') {
                        itemData.rota = position.querySelector('input[name="route"]').value || "-";
                        itemData.km = parseFloat(position.querySelector('input[name="kilometer"]').value) || 0;
                    }

                    itemsForBackend.push(itemData);

                    tableBody.push([
                        formatDate(datum),
                        region,
                        birimLabel,
                        giderTuruLabel,
                        `${netto} ‚Ç¨`,
                        `${kdv} ‚Ç¨`,
                        `${giderMiktari} ‚Ç¨`,
                        beschreibung
                    ]);
                }

                const now = new Date();
                const dateStr = now.toLocaleDateString('tr-TR');
                const timeStr = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                // pdfmake d√∂k√ºman tanƒ±mƒ±
                const docDefinition = {
                    pageSize: 'A4',
                    pageMargins: [40, 60, 40, 60],
                    content: [
                        // Ba≈ülƒ±k
                        {
                            columns: [
                                {
                                    width: '*',
                                    stack: [
                                        { text: 'Aƒ∞F Gƒ∞DER FORMU', style: 'header', color: '#009872' },
                                        { text: 'Avusturya ƒ∞slam Federasyonu', style: 'subheader' }
                                    ]
                                },
                                {
                                    width: 'auto',
                                    stack: [
                                        { text: `${dateStr} - ${timeStr}`, style: 'dateText', alignment: 'right' },
                                        { text: 'Olu≈üturulma Tarihi', style: 'dateLabel', alignment: 'right' }
                                    ]
                                }
                            ],
                            margin: [0, 0, 0, 20]
                        },

                        // Ki≈üisel Bilgiler Kartƒ±
                        {
                            table: {
                                widths: ['*'],
                                body: [
                                    [{ text: 'BA≈ûVURAN Bƒ∞LGƒ∞LERƒ∞', style: 'cardHeader', fillColor: '#009872', color: 'white' }],
                                    [{
                                        stack: [
                                            { text: [{ text: 'ƒ∞sim Soyisim: ', bold: true }, `${name} ${surname}`], margin: [0, 5, 0, 5] },
                                            { text: [{ text: 'IBAN: ', bold: true }, formatIBAN(iban)], margin: [0, 0, 0, 5] },
                                            { text: [{ text: 'Toplam Tutar: ', bold: true }, { text: `${total} ‚Ç¨`, color: '#28a745', bold: true }], margin: [0, 0, 0, 5] }
                                        ],
                                        fillColor: '#f8f9fa',
                                        margin: 10
                                    }]
                                ]
                            },
                            layout: 'noBorders',
                            margin: [0, 0, 0, 20]
                        },

                        // Gider Detaylarƒ± Ba≈ülƒ±ƒüƒ±
                        { text: 'Gƒ∞DER DETAYLARI', style: 'sectionHeader', margin: [0, 0, 0, 10] },

                        // Tablo
                        {
                            table: {
                                headerRows: 1,
                                widths: ['auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto', '*'],
                                body: [
                                    [
                                        { text: 'Tarih', style: 'tableHeader' },
                                        { text: 'BYK', style: 'tableHeader' },
                                        { text: 'Birim', style: 'tableHeader' },
                                        { text: 'T√ºr', style: 'tableHeader' },
                                        { text: 'Net', style: 'tableHeader' },
                                        { text: 'KDV', style: 'tableHeader' },
                                        { text: 'Br√ºt', style: 'tableHeader' },
                                        { text: 'A√ßƒ±klama', style: 'tableHeader' }
                                    ],
                                    ...tableBody
                                ]
                            },
                            layout: {
                                fillColor: function (rowIndex) {
                                    return (rowIndex % 2 === 0) ? '#f8f9fa' : null;
                                },
                                hLineWidth: function (i, node) {
                                    return (i === 0 || i === 1 || i === node.table.body.length) ? 1 : 0.5;
                                },
                                vLineWidth: function () {
                                    return 0;
                                },
                                hLineColor: function (i) {
                                    return i === 1 ? '#009872' : '#dee2e6';
                                }
                            },
                            margin: [0, 0, 0, 20]
                        },

                        // √ñzet
                        {
                            table: {
                                widths: ['*'],
                                body: [
                                    [{
                                        stack: [
                                            {
                                                columns: [
                                                    { text: [{ text: '√ñZET - ', bold: true }, `Toplam Kalem Sayƒ±sƒ±: ${itemsForBackend.length}`], width: '*' },
                                                    { text: `GENEL TOPLAM: ${total} ‚Ç¨`, style: 'totalAmount', alignment: 'right', width: 'auto' }
                                                ]
                                            }
                                        ],
                                        fillColor: '#e8f5f1',
                                        margin: 10
                                    }]
                                ]
                            },
                            layout: 'noBorders',
                            margin: [0, 0, 0, 20]
                        },

                        // Fatura G√∂rselleri (varsa)
                        ...(attachmentImages.length > 0 ? [
                            { text: 'FATURA G√ñRSELLERƒ∞', style: 'sectionHeader', pageBreak: 'before', margin: [0, 0, 0, 15] },
                            ...attachmentImages.map((img, idx) => ({
                                stack: [
                                    { text: img.name, style: 'imageCaption', margin: [0, 0, 0, 5] },
                                    {
                                        image: img.url,
                                        width: 500,
                                        alignment: 'center',
                                        margin: [0, 0, 0, idx < attachmentImages.length - 1 ? 20 : 0]
                                    }
                                ]
                            }))
                        ] : [])
                    ],
                    footer: function (currentPage, pageCount) {
                        return {
                            columns: [
                                { text: 'Bu belge dijital ortamda olu≈üturulmu≈ütur.', style: 'footer', alignment: 'left' },
                                { text: 'Avusturya ƒ∞slam Federasyonu - Gider Y√∂netim Sistemi', style: 'footer', alignment: 'right' }
                            ],
                            margin: [40, 0]
                        };
                    },
                    styles: {
                        header: {
                            fontSize: 22,
                            bold: true,
                            margin: [0, 0, 0, 5]
                        },
                        subheader: {
                            fontSize: 12,
                            color: '#6c757d'
                        },
                        dateText: {
                            fontSize: 10,
                            bold: true
                        },
                        dateLabel: {
                            fontSize: 8,
                            color: '#6c757d'
                        },
                        cardHeader: {
                            fontSize: 12,
                            bold: true,
                            margin: [10, 10, 10, 10]
                        },
                        sectionHeader: {
                            fontSize: 16,
                            bold: true,
                            color: '#212529'
                        },
                        tableHeader: {
                            bold: true,
                            fontSize: 11,
                            color: 'white',
                            fillColor: '#009872',
                            margin: [5, 8, 5, 8]
                        },
                        totalAmount: {
                            fontSize: 12,
                            bold: true,
                            color: '#28a745'
                        },
                        imageCaption: {
                            fontSize: 11,
                            bold: true,
                            color: '#495057',
                            alignment: 'center'
                        },
                        footer: {
                            fontSize: 8,
                            color: '#6c757d'
                        }
                    },
                    defaultStyle: {
                        fontSize: 10,
                        font: 'Roboto'
                    }
                };

                // PDF olu≈ütur
                const pdfBlob = await new Promise((resolve, reject) => {
                    try {
                        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
                        pdfDocGenerator.getBlob((blob) => {
                            resolve(blob);
                        });
                    } catch (error) {
                        reject(error);
                    }
                });

                // Sunucuya g√∂nder
                const safeName = (name + '_' + surname).replace(/[^A-Za-z0-9_\-]+/g, '_');
                const outName = `gider_${Date.now()}_${safeName}.pdf`;
                const pdfFile = new File([pdfBlob], outName, { type: 'application/pdf' });
                const formData = new FormData();
                formData.append('name', name);
                formData.append('surname', surname);
                formData.append('iban', iban);
                formData.append('total', total);

                const payload = { gider_no: giderNo, items: itemsForBackend };
                formData.append('items_json', JSON.stringify(payload));
                formData.append('pdf', pdfFile);

                // WordPress ortamƒ± i√ßin dinamik URL belirleme
                let phpUrl = 'receive_pdf.php';
                if (window.location.pathname.includes('forms-expense')) {
                    const origin = window.location.origin;
                    const pathParts = window.location.pathname.split('/');
                    const formsIndex = pathParts.indexOf('forms-expense');
                    if (formsIndex !== -1) {
                        const basePath = pathParts.slice(0, formsIndex + 1).join('/');
                        phpUrl = origin + basePath + '/receive_pdf.php';
                    }
                }

                dlog('Sending PDF to:', phpUrl);
                const response = await fetch(phpUrl, { method: 'POST', body: formData });
                const ct = (response.headers.get('content-type') || '').toLowerCase();

                if (!response.ok) {
                    const errText = await response.text().catch(() => '');
                    throw new Error(errText || `ƒ∞stek ba≈üarƒ±sƒ±z: ${response.status}`);
                }

                if (!ct.includes('application/json')) {
                    const raw = await response.text().catch(() => '');
                    throw new Error(raw ? `Sunucu JSON yerine ≈üunu d√∂nd√º: ${raw.substring(0, 200)}...` : 'Sunucu beklenen JSON yanƒ±tƒ± d√∂nd√ºrmedi.');
                }

                const data = await response.json();
                if (data.status !== 'success') {
                    throw new Error(data.message || 'PDF g√∂nderilemedi');
                }

                return giderNo;
            } catch (error) {
                console.error('generatePDF hatasƒ±:', error);
                throw error;
            }
        }
    </script>
</body>

</html>